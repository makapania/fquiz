# FQuiz Handoff — 2025-10-26

This document summarizes what we investigated and changed today, the current issues observed (Google sign‑in and passcode behavior), and a clear remediation and verification plan so another engineer can pick up confidently.

## Overview
- App: Next.js 14 (App Router) with NextAuth and Supabase.
- Dev server: `http://localhost:3000` (confirmed running cleanly).
- Primary concerns: dynamic route 404s for `/sets/[id]`, Google OAuth redirect issues, and inconsistent passcode gating.

## What We Did
- Investigated 404s on `/sets/[id]` and found port confusion due to a second dev server on `3004`.
- Stopped the duplicate server and standardized development on `http://localhost:3000`.
- Verified routes and checked server logs to confirm behavior for `/sets`, `/api/auth/session`, `/api/auth/providers`.
- Advised environment fixes for NextAuth (`NEXTAUTH_URL` set to `http://localhost:3000`, ensure `NEXTAUTH_SECRET` is present).
- Cleanly restarted the dev server and verified homepage is live on `3000`.
- Provided guidance to align Google OAuth client with local development port.

## Current Issues
- Google sign‑in intermittently fails (“can’t reach this page”) after account selection.
- Clicking a set sometimes yields 404s or inconsistent passcode challenge visibility.
- Occasional `GET /@vite/client 404` noise in logs (likely benign, tied to dev tooling; not blocking).

## Likely Root Causes
- OAuth misconfiguration: `NEXTAUTH_URL` or Google OAuth Authorized origins/redirect URIs pointing at `3004` while actual dev server is `3000`.
- Dynamic route 404s were previously caused by duplicate dev server; lingering cache or stale browser tabs may still target `3004`.
- Passcode gating depends on Supabase fields (`passcode_required`, `passcode_expires_at`, likely a stored hash); mismatches or missing checks in `[id]/take` and `[id]/study` can hide/skip the challenge.

## Remediation Plan
1) Authentication alignment
- `.env.local`: set `NEXTAUTH_URL=http://localhost:3000` and `NEXTAUTH_SECRET=<random-string>`.
- Google Cloud Console (OAuth Client):
  - Authorized JavaScript origins: `http://localhost:3000`.
  - Authorized redirect URI: `http://localhost:3000/api/auth/callback/google`.
- Restart dev server after changes; clear browser cache/storage for the site.

2) Dynamic route verification
- Ensure only one dev server is running (use port `3000`). Close tabs targeting `3004`.
- Navigate: `/sets` → click a set → ensure the URL remains on `3000`.

3) Passcode gating audit (no code changes made yet)
- Review files:
  - `app/sets/[id]/page.tsx` — entry route and passcode challenge gating.
  - `app/sets/[id]/take/page.tsx` and `app/sets/[id]/study/page.tsx` — require passcode/session validation before proceeding.
  - `app/sets/[id]/PasscodeForm.tsx` (and related): display, validation, and UX states.
- Validate Supabase data for the affected set(s):
  - `passcode_required` (true/false), `passcode_expires_at` (timestamp), and the stored passcode hash/value.
- Expected behavior:
  - If `passcode_required=true` and not validated yet, `/sets/[id]` shows passcode form.
  - Incorrect passcode shows error; correct passcode unlocks and persists validation state.
  - Expired passcode shows an expired message; `/take` and `/study` should enforce these checks.

## Verification Checklist
- `/api/auth/providers` returns Google and matches `3000` URLs.
- Start sign‑in → Google account select → callback returns to `http://localhost:3000/api/auth/callback/google` without leaving `3000`.
- `/api/auth/session` shows a valid session after sign‑in.
- `/sets` loads; clicking a set reaches `/sets/<id>` without 404.
- Passcode prompt appears when required; accepts correct passcode; rejects incorrect; handles expiry.
- `/sets/<id>/take` and `/sets/<id>/study` honor passcode/session gating.

## Environment & Config
- `.env.local` (local dev):
  - `NEXTAUTH_URL=http://localhost:3000`
  - `NEXTAUTH_SECRET=<random-string>`
  - Supabase keys: `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY` (ensure present and valid).
- Restart server after editing env: `npm run dev`.

## Useful Endpoints
- `GET /api/auth/providers` — Confirm configured OAuth providers.
- `GET /api/auth/session` — Confirm current auth session.
- `GET /sets` → `GET /sets/<id>` → `GET /sets/<id>/{take,study}` — Verify route gating and passcode behavior.

## Files Touched/Reviewed
- `app/sets/page.tsx` — list and links to `/sets/[id]`.
- `app/sets/[id]/page.tsx` (+ `PasscodeForm.tsx`, `EditorWithSession.tsx`) — set view and gating.
- `app/sets/[id]/take/page.tsx`, `app/sets/[id]/study/page.tsx` — passcode/session enforcement.
- `src/lib/authOptions.ts` — NextAuth config.
- `next.config.js` — minimal config; no special routing overrides.

## Next Actions
- Confirm Google OAuth console settings match `http://localhost:3000`.
- Validate `.env.local` values and restart.
- Test the verification checklist end‑to‑end.
- If passcode gating still misbehaves, instrument the gating paths to log:
  - Supabase set values, current session state, and the gating decision at `/sets/[id]`, `/take`, and `/study`.

— End of handoff —